cmake_minimum_required( VERSION 3.22 )

# Main project information
project(CesiumOsg
    LANGUAGES
        CXX
    VERSION
        0.0.1
)

message(STATUS "Using CMake ${CMAKE_VERSION}")

# Require out-of-source builds
file(TO_CMAKE_PATH "${PROJECT_BINARY_DIR}/CMakeLists.txt" LOC_PATH)

if ( EXISTS "${LOC_PATH}" )
    message( FATAL_ERROR "You cannot build in the source directory. Please use a build subdirectory." )
endif()

# Turn on link time optimization for everything
set(CMAKE_INTERPROCEDURAL_OPTIMIZATION_RELEASE ON)

# Output compile commands to compile_commands.json (for debugging CMake issues)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# Build universal lib on macOS
# Note that CMAKE_OSX_ARCHITECTURES must be set before project().
if (APPLE)
    set( CMAKE_OSX_ARCHITECTURES "x86_64;arm64" CACHE STRING "" )
endif()

# Source files
set(CESIUM_OSG_HEADER_FILES
	src/Log.h
	src/RuntimeSupport.h
	src/AsyncSystemWrapper.h
    src/AsyncTaskProcessor.h
    src/SimpleAssetAccessor.h
	src/SimpleRenderResourcesPreparer.h
	src/NodeBuilder.h
	src/GltfLoader.h
    src/Cesium3DTileset.h
)

set(CESIUM_OSG_SOURCE_FILES
	src/Log.cpp
	src/AsyncSystemWrapper.cpp
    src/AsyncTaskProcessor.cpp
    src/SimpleAssetAccessor.cpp
    src/SimpleRenderResourcesPreparer.cpp
	src/NodeBuilder.cpp
	src/GltfLoader.cpp
	src/Cesium3DTileset.cpp
    src/main.cpp
)

# Create our library
add_executable(${PROJECT_NAME} ${CESIUM_OSG_HEADER_FILES} ${CESIUM_OSG_SOURCE_FILES})

target_compile_features(${PROJECT_NAME}
    PRIVATE
        cxx_std_20
)

# å¤šé…ç½®ç”Ÿæˆå™¨ä¸‹ï¼Œç›®æ ‡ç›®å½•éœ€åŒ…å« $<CONFIG>
set(TARGET_DIR "$<TARGET_FILE_DIR:${PROJECT_NAME}>")

#
if(MSVC)
    target_compile_options(${PROJECT_NAME} PRIVATE
        /W4 /WX 
        /wd4100 /wd4244 /wd4267 /wd4996 /wd4828 /wd4010
		/wd4505  # ğŸ‘ˆ å¿½ç•¥â€œæœªå¼•ç”¨çš„æœ¬åœ°å‡½æ•°â€è­¦å‘Š
        /utf-8
        # # ç¡®ä¿Debugå’ŒReleaseä½¿ç”¨æ­£ç¡®çš„è¿è¡Œæ—¶åº“
        # $<$<CONFIG:Debug>:/MDd>
        # $<$<CONFIG:Release>:/MD>
    )
    # # Debugæ¨¡å¼ä¿æŒæ–­è¨€ä»¥ä¾¿è°ƒè¯•ï¼ŒReleaseæ¨¡å¼ç¦ç”¨æ–­è¨€
    # target_compile_definitions(${PROJECT_NAME} PRIVATE
    #     $<$<CONFIG:Release>:NDEBUG>
    # )
endif()

# å®šä¹‰é€šç”¨çš„è·¨å¹³å°ã€è·¨ç¼–è¯‘å™¨çš„â€œæ„å»ºç±»å‹å®å®šä¹‰â€
# é€šè¿‡â€œç”Ÿæˆå™¨è¡¨è¾¾å¼â€æ”¯æŒ vsã€xcodeè¿™ç§å¤šé…ç½®ç”Ÿæˆå™¨ï¼Œ
# ä¹Ÿé€‚ç”¨äº Makefileã€Ninja è¿™ç§å•é…ç½®ç”Ÿæˆå™¨
target_compile_definitions(${PROJECT_NAME}
    PRIVATE
	$<$<CONFIG:Debug>:CO_DEBUG_MODE>
	$<$<CONFIG:Release>:CO_RELEASE_MODE>
	$<$<CONFIG:MinSizeRel>:CO_MINSIZEREL_MODE>
	$<$<CONFIG:RelWithDebInfo>:CO_RELWITHDEBINFO_MODE>
)

# æ­¤è®¾ç½®ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ï¼Œå³ï¼šåº“ç¼–è¯‘é…ç½®å†²çªï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨ Cesium Native å’Œå…¶ä¾èµ–çš„ S2 Geometry åº“ 
# ç±»ä¼¼ï¼šerror LNK2038: æ£€æµ‹åˆ°â€œannotate_stringâ€çš„ä¸åŒ¹é…é¡¹: å€¼â€œ0â€ä¸åŒ¹é…å€¼â€œ1â€
# set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fsanitize=address")
target_include_directories(
    ${PROJECT_NAME}
    PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}
        ${CMAKE_CURRENT_SOURCE_DIR}/../Engine
        ${CMAKE_CURRENT_SOURCE_DIR}/../CesiumNativeGL
)

# è‡ªå®šä¹‰å˜é‡ï¼Œè®¾ç½®ä¸‰æ–¹åº“çš„è·¯å¾„
set(THIRD_PARTY_DIR C:/env/libc++)

# OSG
target_include_directories(${PROJECT_NAME} PRIVATE ${THIRD_PARTY_DIR}/osg/Release/include)
# æŸ¥æ‰¾ Debug ç‰ˆæœ¬çš„åº“
find_library(LIB_Osgd osgd ${THIRD_PARTY_DIR}/osg/Debug/lib)
find_library(LIB_OsgDBd osgDBd ${THIRD_PARTY_DIR}/osg/Debug/lib)
find_library(LIB_OsgTextd osgTextd ${THIRD_PARTY_DIR}/osg/Debug/lib)
find_library(LIB_OpenThreadsd OpenThreadsd ${THIRD_PARTY_DIR}/osg/Debug/lib)
find_library(LIB_OsgUtild osgUtild ${THIRD_PARTY_DIR}/osg/Debug/lib)
find_library(LIB_OsgViewerd osgViewerd ${THIRD_PARTY_DIR}/osg/Debug/lib)
find_library(LIB_OsgGAd osgGAd ${THIRD_PARTY_DIR}/osg/Debug/lib)
# æŸ¥æ‰¾ Release ç‰ˆæœ¬çš„åº“
find_library(LIB_Osg osg ${THIRD_PARTY_DIR}/osg/Release/lib)
find_library(LIB_OsgDB osgDB ${THIRD_PARTY_DIR}/osg/Release/lib)
find_library(LIB_OsgText osgText ${THIRD_PARTY_DIR}/osg/Release/lib)
find_library(LIB_OpenThreads OpenThreads ${THIRD_PARTY_DIR}/osg/Release/lib)
find_library(LIB_OsgUtil osgUtil ${THIRD_PARTY_DIR}/osg/Release/lib)
find_library(LIB_OsgViewer osgViewer ${THIRD_PARTY_DIR}/osg/Release/lib)
find_library(LIB_OsgGA osgGA ${THIRD_PARTY_DIR}/osg/Release/lib)

# é“¾æ¥ OSG åº“
target_link_libraries(
	${PROJECT_NAME} PRIVATE
	debug ${LIB_Osgd} optimized ${LIB_Osg}
	debug ${LIB_OsgDBd} optimized ${LIB_OsgDB}
	debug ${LIB_OsgTextd} optimized ${LIB_OsgText}
	debug ${LIB_OpenThreadsd} optimized ${LIB_OpenThreads}
	debug ${LIB_OsgUtild} optimized ${LIB_OsgUtil}
	debug ${LIB_OsgViewerd} optimized ${LIB_OsgViewer}
	debug ${LIB_OsgGAd} optimized ${LIB_OsgGA}
)

# CURL
target_include_directories(${PROJECT_NAME} PRIVATE ${THIRD_PARTY_DIR}/curl/include)
# æŸ¥æ‰¾ Debug ç‰ˆæœ¬çš„åº“
find_library(LIB_CURLd libcurld ${THIRD_PARTY_DIR}/curl/lib/Debug)
# æŸ¥æ‰¾ Release ç‰ˆæœ¬çš„åº“
find_library(LIB_CURL libcurl ${THIRD_PARTY_DIR}/curl/lib/Release)

# é“¾æ¥ CURL åº“
target_link_libraries(
	${PROJECT_NAME} PRIVATE
	debug ${LIB_CURLd} optimized ${LIB_CURL}
)

# Windowså¹³å°æ‰éœ€è¦æ‹·è´åŠ¨æ€åº“
# æ‹·è´OSGåŠ¨æ€åº“åˆ°å¯æ‰§è¡Œç¨‹åºæ‰€åœ¨çš„ç›®å½•
# IN LISTS ä¹‹ååº”è¯¥æ˜¯å˜é‡åè€Œä¸æ˜¯å˜é‡å€¼ï¼Œæ‰€ä»¥ä¸èƒ½åŠ  ${}
if (CMAKE_HOST_WIN32)
	set(LIBS_DEBUG
		# osg	
		${THIRD_PARTY_DIR}/osg/Debug/bin/osgd.dll
		${THIRD_PARTY_DIR}/osg/Debug/bin/osgDBd.dll
		${THIRD_PARTY_DIR}/osg/Debug/bin/osgUtild.dll
		${THIRD_PARTY_DIR}/osg/Debug/bin/osgViewerd.dll
		${THIRD_PARTY_DIR}/osg/Debug/bin/osgTextd.dll
		${THIRD_PARTY_DIR}/osg/Debug/bin/osgGAd.dll
		${THIRD_PARTY_DIR}/osg/Debug/bin/OpenThreadsd.dll
		${THIRD_PARTY_DIR}/osg/Debug/bin/zlibd.dll
		# curl
		${THIRD_PARTY_DIR}/curl/lib/Debug/libcurld.dll
	)

	set(LIBS_RELEASE
		# osg	
		${THIRD_PARTY_DIR}/osg/Release/bin/osg.dll
		${THIRD_PARTY_DIR}/osg/Release/bin/osgDB.dll
		${THIRD_PARTY_DIR}/osg/Release/bin/osgUtil.dll
		${THIRD_PARTY_DIR}/osg/Release/bin/osgViewer.dll
		${THIRD_PARTY_DIR}/osg/Release/bin/osgText.dll
		${THIRD_PARTY_DIR}/osg/Release/bin/osgGA.dll
		${THIRD_PARTY_DIR}/osg/Release/bin/OpenThreads.dll
		${THIRD_PARTY_DIR}/osg/Release/bin/zlib.dll
		# curl
		${THIRD_PARTY_DIR}/curl/lib/Release/libcurl.dll
	)

	# æ‹·è´ä¾èµ–çš„åŠ¨æ€åº“
	add_custom_command(TARGET ${PROJECT_NAME}
		POST_BUILD
		COMMAND ${CMAKE_COMMAND} -E copy_if_different
			"$<$<CONFIG:Debug>:${LIBS_DEBUG}>"
			"$<$<NOT:$<CONFIG:Debug>>:${LIBS_RELEASE}>"
			$<TARGET_FILE_DIR:${PROJECT_NAME}>
		VERBATIM
		COMMENT "Copying dependency libs to ${TARGET_DIR}"
		COMMAND_EXPAND_LISTS
	)
endif()

# æ·»åŠ  CesiumNative ç­‰ä¸‰æ–¹åº“çš„å­ç›®å½•
add_subdirectory(extern)